<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Телесуфлер Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100dvh;
      overflow: hidden;
      position: relative;
    }

    body.theme-dark {
      background: #000;
      color: white;
    }
    body.theme-light {
      background: #fff;
      color: black;
    }

    .screen { display: none; height: 100%; }
    .screen.active { display: flex; flex-direction: column; }

    /* Setup Screen */
    #setup-screen {
      padding: 20px;
      gap: 20px;
    }
    textarea {
      width: 100%;
      height: 40dvh;
      padding: 12px;
      font-size: 18px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #111;
      color: white;
      resize: none;
    }
    .saved-texts {
      max-height: 30dvh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .saved-texts button {
      background: #333;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 6px;
      text-align: left;
      cursor: pointer;
    }
    .controls-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    /* Recording Screen */
    #recording-screen { position: relative; }
    #camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    #no-camera-placeholder {
      display: none;
      width: 100%;
      height: 100%;
      background: inherit;
    }

    .aspect-guide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      box-sizing: border-box;
      border: 2px dashed rgba(255,255,255,0.4);
    }
    body.theme-light .aspect-guide {
      border-color: rgba(0,0,0,0.4);
    }

    #overlay-text-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 20px;
    }
    #text-content {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      line-height: 1.6;
      transform: translateY(0);
    }

    #recording-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      z-index: 10;
    }
    body.theme-dark #recording-controls {
      background: rgba(0, 0, 0, 0.7);
    }
    body.theme-light #recording-controls {
      background: rgba(255, 255, 255, 0.7);
    }

    #controls-content {
      width: 100%;
      display: none; /* Скрыто по умолчанию */
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    input[type="range"] {
      width: 100px;
    }

    .recording {
      background: #e53935 !important;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.8; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body class="theme-dark">

<!-- Setup Screen -->
<div id="setup-screen" class="screen active">
  <h2>Текст для телесуфлера</h2>
  <textarea id="input-text" placeholder="Введите или вставьте ваш текст здесь..."></textarea>
  <div class="saved-texts" id="saved-list"></div>
  <div class="controls-row">
    <button id="load-sample">Загрузить пример</button>
    <button id="go-to-recording">Начать запись</button>
    <button id="go-to-teleprompter-only">Только телесуфлер</button>
  </div>
</div>

<!-- Recording Screen -->
<div id="recording-screen" class="screen">
  <video id="camera" autoplay playsinline muted></video>
  <div id="no-camera-placeholder"></div>
  <div id="guide-9-16" class="aspect-guide"></div>
  <div id="guide-1-1" class="aspect-guide"></div>
  <div id="overlay-text-container">
    <div id="text-content"></div>
  </div>

  <div id="recording-controls">
    <button id="backBtn">← Назад</button>
    <button id="recordToggleBtn">⏺️ Записать</button>
    <button id="promptToggleBtn" style="display:none;">▶️ Старт</button>
    <button id="toggleControlsBtn">☰ Настройки</button>

    <div id="controls-content">
      <div class="slider-group">
        <label>Скорость:</label>
        <input type="range" id="speed" min="0.5" max="5" step="0.5" value="1">
      </div>
      <div class="slider-group">
        <label>Размер:</label>
        <input type="range" id="fontSize" min="16" max="64" value="32">
      </div>
      <div class="slider-group">
        <label>Позиция:</label>
        <input type="range" id="textPosition" min="0" max="100" value="0">
      </div>
      <div class="slider-group">
        <label>Ширина:</label>
        <input type="range" id="textWidth" min="20" max="100" value="80">
      </div>
      <div class="slider-group">
        <label>Фон:</label>
        <input type="range" id="bgOpacity" min="0" max="100" value="60">
      </div>
      <div class="slider-group">
        <label>Режим:</label>
        <select id="aspectRatio">
          <option value="16:9" selected>Горизонтальный (YouTube)</option>
          <option value="9:16">Вертикальный (Shorts/Reels)</option>
          <option value="1:1">Квадрат (Instagram)</option>
        </select>
      </div>
      <div class="slider-group" id="resolution-control" style="display: none;">
        <label>Качество:</label>
        <select id="resolution">
          <option value="640,360">360p (640×360)</option>
          <option value="854,480">480p (854×480)</option>
          <option value="1280,720">720p (1280×720)</option>
          <option value="1920,1080" selected>1080p (1920×1080)</option>
          <option value="2560,1440">1440p (2560×1440)</option>
          <option value="3840,2160">4K (3840×2160)</option>
        </select>
      </div>
      <div class="slider-group">
        <label>Тема:</label>
        <select id="theme">
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
        </select>
      </div>
    </div>
  </div>
</div>

<script>
  const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const savedTexts = JSON.parse(localStorage.getItem('teleprompterTexts') || '[]');
  const savedBgOpacity = parseInt(localStorage.getItem('teleprompterBgOpacity') || '60');
  let currentText = '';
  let stream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let scrollInterval = null;
  let isRecording = false;
  let isPromptRunning = false;
  let currentResolution = isMobile ? [1280, 720] : [1920, 1080];
  let isCameraMode = true;

  // DOM
  const body = document.body;
  const setupScreen = document.getElementById('setup-screen');
  const recordingScreen = document.getElementById('recording-screen');
  const inputText = document.getElementById('input-text');
  const savedList = document.getElementById('saved-list');
  const camera = document.getElementById('camera');
  const noCameraPlaceholder = document.getElementById('no-camera-placeholder');
  const textContent = document.getElementById('text-content');
  const backBtn = document.getElementById('backBtn');
  const recordToggleBtn = document.getElementById('recordToggleBtn');
  const promptToggleBtn = document.getElementById('promptToggleBtn');
  const toggleControlsBtn = document.getElementById('toggleControlsBtn'); // ← новая кнопка
  const controlsContent = document.getElementById('controls-content'); // ← обёртка
  const speedControl = document.getElementById('speed');
  const fontSizeControl = document.getElementById('fontSize');
  const textPositionControl = document.getElementById('textPosition');
  const textWidthControl = document.getElementById('textWidth');
  const bgOpacityControl = document.getElementById('bgOpacity');
  const aspectRatioSelect = document.getElementById('aspectRatio');
  const guide916 = document.getElementById('guide-9-16');
  const guide11 = document.getElementById('guide-1-1');
  const loadSampleBtn = document.getElementById('load-sample');
  const goToRecordingBtn = document.getElementById('go-to-recording');
  const goToTeleprompterOnlyBtn = document.getElementById('go-to-teleprompter-only');
  const resolutionControl = document.getElementById('resolution-control');
  const resolutionSelect = document.getElementById('resolution');
  const themeSelect = document.getElementById('theme');

  bgOpacityControl.value = savedBgOpacity;

  const savedTheme = localStorage.getItem('teleprompterTheme') || 'dark';
  body.className = `theme-${savedTheme}`;
  themeSelect.value = savedTheme;

  if (!isMobile) {
    resolutionControl.style.display = 'flex';
    // На ПК можно сразу показать настройки (опционально)
    // controlsContent.style.display = 'flex';
  }

  function renderSavedTexts() {
    savedList.innerHTML = '';
    savedTexts.forEach(text => {
      const btn = document.createElement('button');
      btn.textContent = text.substring(0, 50) + (text.length > 50 ? '...' : '');
      btn.onclick = () => inputText.value = text;
      savedList.appendChild(btn);
    });
  }
  renderSavedTexts();

  loadSampleBtn.addEventListener('click', () => {
    inputText.value = `Добро пожаловать в телесуфлер Pro!\nНажмите "☰ Настройки", чтобы настроить текст.`;
  });

  function updateTextBackground() {
    const opacity = parseInt(bgOpacityControl.value) / 100;
    const isDark = body.classList.contains('theme-dark');
    const bgColor = isDark ? '0,0,0' : '255,255,255';
    textContent.style.background = `rgba(${bgColor}, ${opacity})`;
    localStorage.setItem('teleprompterBgOpacity', bgOpacityControl.value);
  }
  updateTextBackground();

  function enterRecordingMode(withCamera) {
    currentText = inputText.value.trim();
    if (!currentText) { alert('Введите текст.'); return; }
    if (!savedTexts.includes(currentText)) {
      savedTexts.push(currentText);
      localStorage.setItem('teleprompterTexts', JSON.stringify(savedTexts));
      renderSavedTexts();
    }

    isCameraMode = withCamera;
    textContent.textContent = currentText;
    applyTextStyles();
    updateTextBackground();

    setupScreen.classList.remove('active');
    recordingScreen.classList.add('active');

    if (withCamera) {
      promptToggleBtn.style.display = 'none';
      recordToggleBtn.style.display = 'inline-block';
      camera.style.display = 'block';
      noCameraPlaceholder.style.display = 'none';
      if (!isMobile) resolutionControl.style.display = 'flex';
      startCamera();
    } else {
      camera.style.display = 'none';
      noCameraPlaceholder.style.display = 'block';
      recordToggleBtn.style.display = 'none';
      promptToggleBtn.style.display = 'inline-block';
    }

    // Скрыть настройки при входе (особенно на мобиле)
    controlsContent.style.display = 'none';
    toggleControlsBtn.textContent = '☰ Настройки';

    setTimeout(() => updateTextPosition(), 50);
    updateGuides();
  }

  goToRecordingBtn.addEventListener('click', () => enterRecordingMode(true));
  goToTeleprompterOnlyBtn.addEventListener('click', () => enterRecordingMode(false));

  backBtn.addEventListener('click', () => {
    recordingScreen.classList.remove('active');
    setupScreen.classList.add('active');
    stopCamera();
    stopPrompt();
  });

  // === Переключение меню настроек ===
  toggleControlsBtn.addEventListener('click', () => {
    if (controlsContent.style.display === 'flex') {
      controlsContent.style.display = 'none';
      toggleControlsBtn.textContent = '☰ Настройки';
    } else {
      controlsContent.style.display = 'flex';
      toggleControlsBtn.textContent = '▲ Скрыть';
    }
  });

  // === Остальной код без изменений в логике ===
  function updateTextPosition() {
    const container = document.getElementById('overlay-text-container');
    if (!container || !textContent) return;
    const posPercent = parseFloat(textPositionControl.value) || 0;
    const maxDownwardOffset = Math.max(0, container.clientHeight - textContent.scrollHeight);
    const topOffset = (posPercent / 100) * maxDownwardOffset;
    textContent.style.transform = `translateY(${topOffset}px)`;
  }

  textPositionControl.addEventListener('input', () => {
    updateTextPosition();
    if (!isRecording && !isPromptRunning && scrollInterval) {
      clearInterval(scrollInterval);
      scrollInterval = null;
    }
  });

  promptToggleBtn.addEventListener('click', () => {
    if (isPromptRunning) {
      stopPrompt();
    } else {
      startPrompt();
    }
  });

  function startPrompt() {
    if (scrollInterval) clearInterval(scrollInterval);
    isPromptRunning = true;
    promptToggleBtn.textContent = '⏸️ Пауза';

    const speed = parseFloat(speedControl.value);
    const container = document.getElementById('overlay-text-container');
    const posPercent = parseFloat(textPositionControl.value) || 0;
    const maxDownwardOffset = Math.max(0, container.clientHeight - textContent.scrollHeight);
    let topOffset = (posPercent / 100) * maxDownwardOffset;

    scrollInterval = setInterval(() => {
      topOffset -= speed;
      if (topOffset < -textContent.scrollHeight) {
        topOffset = (posPercent / 100) * maxDownwardOffset;
      }
      textContent.style.transform = `translateY(${topOffset}px)`;
    }, 50);
  }

  function stopPrompt() {
    if (scrollInterval) clearInterval(scrollInterval);
    scrollInterval = null;
    isPromptRunning = false;
    promptToggleBtn.textContent = '▶️ Старт';
    updateTextPosition();
  }

  recordToggleBtn.addEventListener('click', () => {
    if (isRecording) {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    } else {
      if (!stream) {
        alert('Сначала дождитесь загрузки камеры.');
        return;
      }

      const hasAudio = stream.getAudioTracks().length > 0;
      if (!hasAudio) {
        if (!confirm('Микрофон недоступен. Записать только видео?')) return;
      }

      const mimeType = MediaRecorder.isTypeSupported('video/mp4;codecs=h264')
        ? 'video/mp4;codecs=h264'
        : MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
          ? 'video/webm;codecs=vp9'
          : 'video/webm';

      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType });
      mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: mimeType });
        const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `teleprompter-recording.${ext}`;
        a.click();
        URL.revokeObjectURL(url);
        isRecording = false;
        recordToggleBtn.classList.remove('recording');
        recordToggleBtn.textContent = '⏺️ Записать';
        recordToggleBtn.disabled = false;
        if (scrollInterval) {
          clearInterval(scrollInterval);
          scrollInterval = null;
        }
        updateTextPosition();
      };

      mediaRecorder.start();
      isRecording = true;
      recordToggleBtn.classList.add('recording');
      recordToggleBtn.textContent = '⏹️ Остановить';
      recordToggleBtn.disabled = false;

      if (scrollInterval) clearInterval(scrollInterval);
      const speed = parseFloat(speedControl.value);
      const container = document.getElementById('overlay-text-container');
      const posPercent = parseFloat(textPositionControl.value) || 0;
      const maxDownwardOffset = Math.max(0, container.clientHeight - textContent.scrollHeight);
      let topOffset = (posPercent / 100) * maxDownwardOffset;
      scrollInterval = setInterval(() => {
        topOffset -= speed;
        if (topOffset < -textContent.scrollHeight) {
          topOffset = (posPercent / 100) * maxDownwardOffset;
        }
        textContent.style.transform = `translateY(${topOffset}px)`;
      }, 50);
    }
  });

  bgOpacityControl.addEventListener('input', updateTextBackground);

  async function startCamera() {
    stopCamera();
    const [width, height] = currentResolution;
    const constraints = {
      video: { facingMode: 'user', width: { ideal: width }, height: { ideal: height } },
      audio: true
    };

    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      camera.srcObject = stream;
    } catch (err) {
      let msg = 'Не удалось получить доступ к камере/микрофону.';
      if (err.name === 'NotFoundError') msg = 'Камера или микрофон не найдены.';
      if (err.name === 'NotAllowedError') msg = 'Доступ запрещён. Разрешите в настройках браузера.';
      alert(msg + '\n\nОшибка: ' + err.message);
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    if (scrollInterval && isRecording) {
      clearInterval(scrollInterval);
      scrollInterval = null;
    }
  }

  resolutionSelect.addEventListener('change', () => {
    const [w, h] = resolutionSelect.value.split(',').map(Number);
    currentResolution = [w, h];
    if (isCameraMode) startCamera();
  });

  themeSelect.addEventListener('change', () => {
    const theme = themeSelect.value;
    body.className = `theme-${theme}`;
    localStorage.setItem('teleprompterTheme', theme);
    updateTextBackground();
  });

  function updateGuides() {
    guide916.style.display = 'none';
    guide11.style.display = 'none';
    if (!isCameraMode) return;

    const ratio = aspectRatioSelect.value;
    if (ratio === '9:16') {
      guide916.style.display = 'block';
      const targetW = window.innerHeight * (9 / 16);
      const ml = (window.innerWidth - targetW) / 2;
      guide916.style.marginLeft = ml + 'px';
      guide916.style.width = targetW + 'px';
      guide916.style.height = '100%';
    } else if (ratio === '1:1') {
      guide11.style.display = 'block';
      const size = Math.min(window.innerWidth, window.innerHeight);
      const ml = (window.innerWidth - size) / 2;
      const mt = (window.innerHeight - size) / 2;
      guide11.style.marginLeft = ml + 'px';
      guide11.style.marginTop = mt + 'px';
      guide11.style.width = size + 'px';
      guide11.style.height = size + 'px';
    }
  }

  aspectRatioSelect.addEventListener('change', updateGuides);
  window.addEventListener('resize', updateGuides);

  function applyTextStyles() {
    textContent.style.fontSize = fontSizeControl.value + 'px';
    textContent.style.maxWidth = textWidthControl.value + '%';
  }

  fontSizeControl.addEventListener('input', applyTextStyles);
  textWidthControl.addEventListener('input', applyTextStyles);

  window.addEventListener('beforeunload', () => {
    stopCamera();
    stopPrompt();
  });
</script>
</body>
</html>
