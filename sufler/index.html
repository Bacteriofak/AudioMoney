<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–¢–µ–ª–µ—Å—É—Ñ–ª–µ—Ä Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100dvh;
      overflow: hidden;
      position: relative;
    }

    body.theme-dark {
      background: #000;
      color: white;
    }
    body.theme-light {
      background: #fff;
      color: black;
    }

    .screen { display: none; height: 100%; }
    .screen.active { display: flex; flex-direction: column; }

    /* Setup Screen */
    #setup-screen {
      padding: 20px;
      gap: 20px;
    }
    textarea {
      width: 100%;
      height: 40dvh;
      padding: 12px;
      font-size: 18px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #111;
      color: white;
      resize: none;
    }
    .saved-texts {
      max-height: 30dvh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .saved-texts button {
      background: #333;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 6px;
      text-align: left;
      cursor: pointer;
    }
    .controls-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    /* Recording Screen */
    #recording-screen { position: relative; }
    #camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
      transform-origin: center;
    }
    #no-camera-placeholder {
      display: none;
      width: 100%;
      height: 100%;
      background: inherit;
    }

    .aspect-guide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      box-sizing: border-box;
      border: 2px dashed rgba(255,255,255,0.4);
    }
    body.theme-light .aspect-guide {
      border-color: rgba(0,0,0,0.4);
    }

    #overlay-text-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 20px;
    }
    #text-content {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      line-height: 1.6;
      transform: translateY(0);
    }
    body.theme-dark #text-content {
      color: white;
      background: rgba(0, 0, 0, 0.6);
    }
    body.theme-light #text-content {
      color: black;
      background: rgba(255, 255, 255, 0.6);
    }

    #recording-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      z-index: 10;
    }
    body.theme-dark #recording-controls {
      background: rgba(0, 0, 0, 0.7);
    }
    body.theme-light #recording-controls {
      background: rgba(255, 255, 255, 0.7);
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    input[type="range"] {
      width: 100px;
    }

    .recording {
      background: #e53935 !important;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.8; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body class="theme-dark">

<!-- Setup Screen -->
<div id="setup-screen" class="screen active">
  <h2>–¢–µ–∫—Å—Ç –¥–ª—è —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä–∞</h2>
  <textarea id="input-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å..."></textarea>
  <div class="saved-texts" id="saved-list"></div>
  <div class="controls-row">
    <button id="load-sample">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
    <button id="go-to-recording">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button id="go-to-teleprompter-only">–¢–æ–ª—å–∫–æ —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä</button>
  </div>
</div>

<!-- Recording Screen -->
<div id="recording-screen" class="screen">
  <video id="camera" autoplay playsinline muted></video>
  <div id="no-camera-placeholder"></div>
  <div id="guide-9-16" class="aspect-guide"></div>
  <div id="guide-1-1" class="aspect-guide"></div>
  <div id="overlay-text-container">
    <div id="text-content"></div>
  </div>

  <div id="camera-settings" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 10px; max-width: 300px; display: none; z-index: 20;">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</h3>
    <div id="camera-settings-content"></div>
  </div>

  <div id="recording-controls">
    <button id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
    <!-- –ï–î–ò–ù–ê–Ø –ö–ù–û–ü–ö–ê –ó–ê–ü–ò–°–ò -->
    <button id="recordToggleBtn">‚è∫Ô∏è –ó–∞–ø–∏—Å–∞—Ç—å</button>
    <!-- –ï–î–ò–ù–ê–Ø –ö–ù–û–ü–ö–ê –¢–ï–õ–ï–°–£–§–õ–ï–†–ê -->
    <button id="promptToggleBtn" style="display:none;">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
    <button id="cameraSettingsBtn" style="display: none;">üé• –ö–∞–º–µ—Ä–∞</button>

    <div class="slider-group">
      <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
      <input type="range" id="speed" min="0.5" max="5" step="0.5" value="1">
    </div>
    <div class="slider-group">
      <label>–†–∞–∑–º–µ—Ä:</label>
      <input type="range" id="fontSize" min="16" max="64" value="32">
    </div>
    <div class="slider-group">
      <label>–ü–æ–∑–∏—Ü–∏—è:</label>
      <input type="range" id="textPosition" min="0" max="100" value="0">
    </div>
    <div class="slider-group">
      <label>–®–∏—Ä–∏–Ω–∞:</label>
      <input type="range" id="textWidth" min="20" max="100" value="80">
    </div>
    <div class="slider-group">
      <label>–†–µ–∂–∏–º:</label>
      <select id="aspectRatio">
        <option value="16:9" selected>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (YouTube)</option>
        <option value="9:16">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (Shorts/Reels)</option>
        <option value="1:1">–ö–≤–∞–¥—Ä–∞—Ç (Instagram)</option>
      </select>
    </div>
    <div class="slider-group" id="resolution-control" style="display: none;">
      <label>–ö–∞—á–µ—Å—Ç–≤–æ:</label>
      <select id="resolution">
        <option value="640,360">360p (640√ó360)</option>
        <option value="854,480">480p (854√ó480)</option>
        <option value="1280,720">720p (1280√ó720)</option>
        <option value="1920,1080" selected>1080p (1920√ó1080)</option>
        <option value="2560,1440">1440p (2560√ó1440)</option>
        <option value="3840,2160">4K (3840√ó2160)</option>
      </select>
    </div>
    <div class="slider-group">
      <label>–¢–µ–º–∞:</label>
      <select id="theme">
        <option value="dark">–¢—ë–º–Ω–∞—è</option>
        <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
      </select>
    </div>
  </div>
</div>

<script>
  const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const savedTexts = JSON.parse(localStorage.getItem('teleprompterTexts') || '[]');
  let currentText = '';
  let stream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let scrollInterval = null;
  let isRecording = false;
  let isPromptRunning = false;
  let videoTrack = null;
  let currentResolution = isMobile ? [1280, 720] : [1920, 1080];
  let currentScale = 1.0;
  let isCameraMode = true;

  // DOM
  const body = document.body;
  const setupScreen = document.getElementById('setup-screen');
  const recordingScreen = document.getElementById('recording-screen');
  const inputText = document.getElementById('input-text');
  const savedList = document.getElementById('saved-list');
  const camera = document.getElementById('camera');
  const noCameraPlaceholder = document.getElementById('no-camera-placeholder');
  const textContent = document.getElementById('text-content');
  const backBtn = document.getElementById('backBtn');
  const recordToggleBtn = document.getElementById('recordToggleBtn');
  const promptToggleBtn = document.getElementById('promptToggleBtn');
  const speedControl = document.getElementById('speed');
  const fontSizeControl = document.getElementById('fontSize');
  const textPositionControl = document.getElementById('textPosition');
  const textWidthControl = document.getElementById('textWidth');
  const aspectRatioSelect = document.getElementById('aspectRatio');
  const guide916 = document.getElementById('guide-9-16');
  const guide11 = document.getElementById('guide-1-1');
  const loadSampleBtn = document.getElementById('load-sample');
  const goToRecordingBtn = document.getElementById('go-to-recording');
  const goToTeleprompterOnlyBtn = document.getElementById('go-to-teleprompter-only');
  const cameraSettingsBtn = document.getElementById('cameraSettingsBtn');
  const cameraSettings = document.getElementById('camera-settings');
  const cameraSettingsContent = document.getElementById('camera-settings-content');
  const resolutionControl = document.getElementById('resolution-control');
  const resolutionSelect = document.getElementById('resolution');
  const themeSelect = document.getElementById('theme');

  // –¢–µ–º–∞
  const savedTheme = localStorage.getItem('teleprompterTheme') || 'dark';
  body.className = `theme-${savedTheme}`;
  themeSelect.value = savedTheme;

  if (!isMobile) {
    cameraSettingsBtn.style.display = 'inline-block';
    resolutionControl.style.display = 'flex';
  }

  function renderSavedTexts() {
    savedList.innerHTML = '';
    savedTexts.forEach(text => {
      const btn = document.createElement('button');
      btn.textContent = text.substring(0, 50) + (text.length > 50 ? '...' : '');
      btn.onclick = () => inputText.value = text;
      savedList.appendChild(btn);
    });
  }
  renderSavedTexts();

  loadSampleBtn.addEventListener('click', () => {
    inputText.value = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä Pro!\n–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Ä–µ–ø–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ.\n–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", –∏ —Ç–µ–∫—Å—Ç –Ω–∞—á–Ω—ë—Ç –ø–ª–∞–≤–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è –≤–≤–µ—Ä—Ö.`;
  });

  function enterRecordingMode(withCamera) {
    currentText = inputText.value.trim();
    if (!currentText) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç.'); return; }
    if (!savedTexts.includes(currentText)) {
      savedTexts.push(currentText);
      localStorage.setItem('teleprompterTexts', JSON.stringify(savedTexts));
      renderSavedTexts();
    }

    isCameraMode = withCamera;
    textContent.textContent = currentText;
    applyTextStyles();

    setupScreen.classList.remove('active');
    recordingScreen.classList.add('active');

    if (withCamera) {
      promptToggleBtn.style.display = 'none';
      recordToggleBtn.style.display = 'inline-block';
      recordToggleBtn.textContent = '‚è∫Ô∏è –ó–∞–ø–∏—Å–∞—Ç—å';
      recordToggleBtn.classList.remove('recording');
      recordToggleBtn.disabled = false;
      camera.style.display = 'block';
      noCameraPlaceholder.style.display = 'none';
      if (!isMobile) {
        cameraSettingsBtn.style.display = 'inline-block';
        resolutionControl.style.display = 'flex';
      }
      startCamera();
    } else {
      camera.style.display = 'none';
      noCameraPlaceholder.style.display = 'block';
      recordToggleBtn.style.display = 'none';
      promptToggleBtn.style.display = 'inline-block';
      promptToggleBtn.textContent = '‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç';
      isPromptRunning = false;
    }

    setTimeout(() => updateTextPosition(), 50);
    updateGuides();
  }

  goToRecordingBtn.addEventListener('click', () => enterRecordingMode(true));
  goToTeleprompterOnlyBtn.addEventListener('click', () => enterRecordingMode(false));

  backBtn.addEventListener('click', () => {
    recordingScreen.classList.remove('active');
    setupScreen.classList.add('active');
    stopCamera();
    stopPrompt();
  });

  // === –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) ===
  function updateTextPosition() {
    const container = document.getElementById('overlay-text-container');
    if (!container || !textContent) return;
    const posPercent = parseFloat(textPositionControl.value) || 0;
    const maxDownwardOffset = Math.max(0, container.clientHeight - textContent.scrollHeight);
    const topOffset = (posPercent / 100) * maxDownwardOffset;
    textContent.style.transform = `translateY(${topOffset}px)`;
  }

  textPositionControl.addEventListener('input', () => {
    updateTextPosition();
    if (!isRecording && !isPromptRunning && scrollInterval) {
      clearInterval(scrollInterval);
      scrollInterval = null;
    }
  });

  // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–õ–ï–°–£–§–õ–ï–†–û–ú (–û–î–ù–ê –ö–ù–û–ü–ö–ê) ===
  promptToggleBtn.addEventListener('click', () => {
    if (isPromptRunning) {
      // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
      stopPrompt();
    } else {
      // –ó–∞–ø—É—Å—Ç–∏—Ç—å
      startPrompt();
    }
  });

  function startPrompt() {
    if (scrollInterval) clearInterval(scrollInterval);
    isPromptRunning = true;
    promptToggleBtn.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';

    const speed = parseFloat(speedControl.value);
    const container = document.getElementById('overlay-text-container');
    const posPercent = parseFloat(textPositionControl.value) || 0;
    const maxDownwardOffset = Math.max(0, container.clientHeight - textContent.scrollHeight);
    let topOffset = (posPercent / 100) * maxDownwardOffset;

    scrollInterval = setInterval(() => {
      topOffset -= speed;
      if (topOffset < -textContent.scrollHeight) {
        topOffset = (posPercent / 100) * maxDownwardOffset;
      }
      textContent.style.transform = `translateY(${topOffset}px)`;
    }, 50);
  }

  function stopPrompt() {
    if (scrollInterval) clearInterval(scrollInterval);
    scrollInterval = null;
    isPromptRunning = false;
    promptToggleBtn.textContent = '‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç';
    updateTextPosition();
  }

  // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–¨–Æ (–û–î–ù–ê –ö–ù–û–ü–ö–ê) ===
  recordToggleBtn.addEventListener('click', () => {
    if (isRecording) {
      // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    } else {
      // –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
      if (!stream) {
        alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä—ã.');
        return;
      }

      const hasAudio = stream.getAudioTracks().length > 0;
      if (!hasAudio) {
        if (!confirm('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ?')) return;
      }

      const mimeType = MediaRecorder.isTypeSupported('video/mp4;codecs=h264')
        ? 'video/mp4;codecs=h264'
        : MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
          ? 'video/webm;codecs=vp9'
          : 'video/webm';

      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType });
      mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: mimeType });
        const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `teleprompter-recording.${ext}`;
        a.click();
        URL.revokeObjectURL(url);
        isRecording = false;
        recordToggleBtn.classList.remove('recording');
        recordToggleBtn.textContent = '‚è∫Ô∏è –ó–∞–ø–∏—Å–∞—Ç—å';
        recordToggleBtn.disabled = false;
        if (scrollInterval) {
          clearInterval(scrollInterval);
          scrollInterval = null;
        }
        updateTextPosition();
      };

      mediaRecorder.start();
      isRecording = true;
      recordToggleBtn.classList.add('recording');
      recordToggleBtn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
      recordToggleBtn.disabled = false;

      // –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É
      if (scrollInterval) clearInterval(scrollInterval);
      const speed = parseFloat(speedControl.value);
      const container = document.getElementById('overlay-text-container');
      const posPercent = parseFloat(textPositionControl.value) || 0;
      const maxDownwardOffset = Math.max(0, container.clientHeight - textContent.scrollHeight);
      let topOffset = (posPercent / 100) * maxDownwardOffset;
      scrollInterval = setInterval(() => {
        topOffset -= speed;
        if (topOffset < -textContent.scrollHeight) {
          topOffset = (posPercent / 100) * maxDownwardOffset;
        }
        textContent.style.transform = `translateY(${topOffset}px)`;
      }, 50);
    }
  });

  // === –ö–∞–º–µ—Ä–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª–æ–≥–∏–∫–µ) ===
  async function startCamera() {
    stopCamera();
    const [width, height] = currentResolution;
    const constraints = {
      video: { facingMode: 'user', width: { ideal: width }, height: { ideal: height } },
      audio: true
    };

    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      camera.srcObject = stream;
      videoTrack = stream.getVideoTracks()[0];
      if (!isMobile && videoTrack && typeof videoTrack.getCapabilities === 'function') {
        loadCameraSettings();
      }
      camera.style.transform = `scale(${currentScale})`;
    } catch (err) {
      let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
      if (err.name === 'NotFoundError') msg = '–ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
      if (err.name === 'NotAllowedError') msg = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
      alert(msg + '\n\n–û—à–∏–±–∫–∞: ' + err.message);
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      videoTrack = null;
    }
    if (scrollInterval && isRecording) {
      clearInterval(scrollInterval);
      scrollInterval = null;
    }
    cameraSettings.classList.remove('active');
  }

  function loadCameraSettings() {
    try {
      const capabilities = videoTrack ? videoTrack.getCapabilities() : {};
      cameraSettingsContent.innerHTML = '';

      const supported = ['zoom', 'focusDistance', 'exposureCompensation', 'brightness', 'contrast', 'saturation', 'whiteBalanceMode'];
      supported.forEach(prop => {
        if (capabilities[prop]) {
          const range = capabilities[prop];
          const settings = videoTrack.getSettings();
          const currentValue = settings[prop] || (prop === 'zoom' ? 1 : 0);
          const div = document.createElement('div');
          div.className = 'setting-item';
          div.innerHTML = `
            <label>${prop} (${range.min} ‚Äì ${range.max})</label>
            <input type="range" id="cam-${prop}" min="${range.min}" max="${range.max}" step="${range.step || 1}" value="${currentValue}">
          `;
          cameraSettingsContent.appendChild(div);
          div.querySelector('input').addEventListener('input', async (e) => {
            try {
              const val = parseFloat(e.target.value);
              await videoTrack.applyConstraints({ advanced: [{ [prop]: val }] });
            } catch (err) {
              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å', prop, err);
            }
          });
        }
      });

      const scaleDiv = document.createElement('div');
      scaleDiv.className = 'setting-item';
      scaleDiv.innerHTML = `
        <label>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± (0.6‚Äì1.5)</label>
        <input type="range" id="virtual-scale" min="0.6" max="1.5" step="0.05" value="${currentScale}">
      `;
      cameraSettingsContent.appendChild(scaleDiv);
      scaleDiv.querySelector('input').addEventListener('input', (e) => {
        currentScale = parseFloat(e.target.value);
        camera.style.transform = `scale(${currentScale})`;
      });

    } catch (err) {
      console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã', err);
      cameraSettingsContent.innerHTML = `
        <div class="setting-item">
          <label>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± (0.6‚Äì1.5)</label>
          <input type="range" id="virtual-scale" min="0.6" max="1.5" step="0.05" value="${currentScale}">
        </div>
      `;
      document.getElementById('virtual-scale').addEventListener('input', (e) => {
        currentScale = parseFloat(e.target.value);
        camera.style.transform = `scale(${currentScale})`;
      });
    }
  }

  cameraSettingsBtn.addEventListener('click', () => {
    cameraSettings.classList.toggle('active');
  });

  resolutionSelect.addEventListener('change', () => {
    const [w, h] = resolutionSelect.value.split(',').map(Number);
    currentResolution = [w, h];
    if (isCameraMode) startCamera();
  });

  themeSelect.addEventListener('change', () => {
    const theme = themeSelect.value;
    body.className = `theme-${theme}`;
    localStorage.setItem('teleprompterTheme', theme);
  });

  function updateGuides() {
    guide916.style.display = 'none';
    guide11.style.display = 'none';
    if (!isCameraMode) return;

    const ratio = aspectRatioSelect.value;
    if (ratio === '9:16') {
      guide916.style.display = 'block';
      const targetW = window.innerHeight * (9 / 16);
      const ml = (window.innerWidth - targetW) / 2;
      guide916.style.marginLeft = ml + 'px';
      guide916.style.width = targetW + 'px';
      guide916.style.height = '100%';
    } else if (ratio === '1:1') {
      guide11.style.display = 'block';
      const size = Math.min(window.innerWidth, window.innerHeight);
      const ml = (window.innerWidth - size) / 2;
      const mt = (window.innerHeight - size) / 2;
      guide11.style.marginLeft = ml + 'px';
      guide11.style.marginTop = mt + 'px';
      guide11.style.width = size + 'px';
      guide11.style.height = size + 'px';
    }
  }

  aspectRatioSelect.addEventListener('change', updateGuides);
  window.addEventListener('resize', updateGuides);

  function applyTextStyles() {
    textContent.style.fontSize = fontSizeControl.value + 'px';
    textContent.style.maxWidth = textWidthControl.value + '%';
  }

  fontSizeControl.addEventListener('input', applyTextStyles);
  textWidthControl.addEventListener('input', applyTextStyles);

  window.addEventListener('beforeunload', () => {
    stopCamera();
    stopPrompt();
  });
</script>
</body>
</html>
