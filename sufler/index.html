<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–¢–µ–ª–µ—Å—É—Ñ–ª–µ—Ä Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
      color: white;
      height: 100dvh;
      overflow: hidden;
      position: relative;
    }

    .screen { display: none; height: 100%; }
    .screen.active { display: flex; flex-direction: column; }

    /* --- Setup Screen --- */
    #setup-screen {
      padding: 20px;
      gap: 20px;
    }
    textarea {
      width: 100%;
      height: 40dvh;
      padding: 12px;
      font-size: 18px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #111;
      color: white;
      resize: none;
    }
    .saved-texts {
      max-height: 30dvh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .saved-texts button {
      background: #333;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 6px;
      text-align: left;
      cursor: pointer;
    }
    .controls-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    /* --- Recording Screen --- */
    #recording-screen { position: relative; }
    #camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }

    /* –†–∞–º–∫–∞ –¥–ª—è 9:16 –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
    #aspect-guide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: none;
      border: 2px dashed rgba(255,255,255,0.3);
      box-sizing: border-box;
    }

    #overlay-text-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* —Ç–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É! */
      padding-top: 20px;
    }
    #text-content {
      color: white;
      background: rgba(0, 0, 0, 0.6);
      padding: 16px;
      border-radius: 12px;
      max-width: 90%;
      text-align: center;
      line-height: 1.6;
      transform: translateY(0);
    }

    #recording-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.7);
      padding: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      z-index: 10;
    }
    .slider-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    input[type="range"] {
      width: 100px;
    }

    /* –°—Ç–∏–ª—å –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ */
    .recording {
      background: #e53935 !important;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.8; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>

<!-- Setup Screen -->
<div id="setup-screen" class="screen active">
  <h2>–¢–µ–∫—Å—Ç –¥–ª—è —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä–∞</h2>
  <textarea id="input-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å..."></textarea>
  <div class="saved-texts" id="saved-list"></div>
  <div class="controls-row">
    <button id="load-sample">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
    <button id="go-to-recording">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>
</div>

<!-- Recording Screen -->
<div id="recording-screen" class="screen">
  <video id="camera" autoplay playsinline muted></video>
  <div id="aspect-guide"></div>
  <div id="overlay-text-container">
    <div id="text-content"></div>
  </div>
  <div id="recording-controls">
    <button id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
    <button id="recordBtn">‚è∫Ô∏è –ó–∞–ø–∏—Å–∞—Ç—å</button>
    <button id="stopBtn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

    <div class="slider-group">
      <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
      <input type="range" id="speed" min="0.5" max="5" step="0.5" value="1">
    </div>
    <div class="slider-group">
      <label>–†–∞–∑–º–µ—Ä:</label>
      <input type="range" id="fontSize" min="16" max="64" value="32">
    </div>
    <div class="slider-group">
      <label>–ü–æ–∑–∏—Ü–∏—è:</label>
      <input type="range" id="textPosition" min="0" max="100" value="0">
    </div>
    <div class="slider-group">
      <label>–†–µ–∂–∏–º:</label>
      <select id="aspectRatio">
        <option value="9:16">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (Shorts/Reels)</option>
        <option value="16:9" selected>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (YouTube)</option>
        <option value="1:1">–ö–≤–∞–¥—Ä–∞—Ç (Instagram)</option>
      </select>
    </div>
  </div>
</div>

<script>
  // === –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ===
  const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  console.log('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:', isMobile ? '–ú–æ–±–∏–ª—å–Ω–æ–µ' : '–ü–ö');

  // === –î–∞–Ω–Ω—ã–µ ===
  const savedTexts = JSON.parse(localStorage.getItem('teleprompterTexts') || '[]');
  let currentText = '';
  let stream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let scrollInterval = null;
  let isRecording = false;

  // === DOM ===
  const setupScreen = document.getElementById('setup-screen');
  const recordingScreen = document.getElementById('recording-screen');
  const inputText = document.getElementById('input-text');
  const savedList = document.getElementById('saved-list');
  const camera = document.getElementById('camera');
  const textContent = document.getElementById('text-content');
  const backBtn = document.getElementById('backBtn');
  const recordBtn = document.getElementById('recordBtn');
  const stopBtn = document.getElementById('stopBtn');
  const speedControl = document.getElementById('speed');
  const fontSizeControl = document.getElementById('fontSize');
  const textPositionControl = document.getElementById('textPosition');
  const aspectRatioSelect = document.getElementById('aspectRatio');
  const aspectGuide = document.getElementById('aspect-guide');
  const loadSampleBtn = document.getElementById('load-sample');
  const goToRecordingBtn = document.getElementById('go-to-recording');

  // === –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã ===
  function renderSavedTexts() {
    savedList.innerHTML = '';
    savedTexts.forEach((text, i) => {
      const btn = document.createElement('button');
      btn.textContent = text.substring(0, 50) + (text.length > 50 ? '...' : '');
      btn.onclick = () => { inputText.value = text; };
      savedList.appendChild(btn);
    });
  }
  renderSavedTexts();

  // === –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ ===
  loadSampleBtn.addEventListener('click', () => {
    inputText.value = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä Pro!\n–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É –∏ –ø–ª–∞–≤–Ω–æ —É—Ö–æ–¥–∏—Ç –≤–≤–µ—Ä—Ö.\n–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å, —Ä–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–¥ —Å–µ–±—è.`;
  });

  // === –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–∞–ø–∏—Å–∏ ===
  goToRecordingBtn.addEventListener('click', () => {
    currentText = inputText.value.trim();
    if (!currentText) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç.'); return; }
    if (!savedTexts.includes(currentText)) {
      savedTexts.push(currentText);
      localStorage.setItem('teleprompterTexts', JSON.stringify(savedTexts));
      renderSavedTexts();
    }
    textContent.textContent = currentText;
    textContent.style.fontSize = fontSizeControl.value + 'px';
    setupScreen.classList.remove('active');
    recordingScreen.classList.add('active');
    if (isMobile) {
      detectOrientationAndStart();
      window.addEventListener('orientationchange', detectOrientationAndStart);
    } else {
      startCamera(aspectRatioSelect.value);
    }
  });

  // === –ù–∞–∑–∞–¥ ===
  backBtn.addEventListener('click', () => {
    recordingScreen.classList.remove('active');
    setupScreen.classList.add('active');
    stopCamera();
    if (isMobile) {
      window.removeEventListener('orientationchange', detectOrientationAndStart);
    }
  });

  // === –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ===
  function detectOrientationAndStart() {
    if (!isMobile) return;
    const angle = window.orientation || 0;
    // –ü–æ—Ä—Ç—Ä–µ—Ç: 0, 180 ‚Üí 9:16; –õ–∞–Ω–¥—Å–∫–µ–π–ø: 90, -90 ‚Üí 16:9
    const isPortrait = angle === 0 || angle === 180;
    aspectRatioSelect.value = isPortrait ? '9:16' : '16:9';
    startCamera(aspectRatioSelect.value);
  }

  // === –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã ===
  async function startCamera(ratio) {
    stopCamera();
    const [w, h] = parseAspectRatio(ratio);
    const constraints = {
      video: { facingMode: 'user', width: { ideal: w }, height: { ideal: h } },
      audio: true
    };
    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      camera.srcObject = stream;
      applyAspectRatioUI(ratio);
      startScrolling();
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + err.message);
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    if (scrollInterval) clearInterval(scrollInterval);
  }

  function parseAspectRatio(ratio) {
    if (ratio === '9:16') return [1080, 1920];
    if (ratio === '16:9') return [1920, 1080];
    if (ratio === '1:1') return [1080, 1080];
    return [1280, 720];
  }

  // === –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è ===
  function applyAspectRatioUI(ratio) {
    aspectGuide.style.display = 'none';
    camera.style.objectFit = 'cover';

    if (!isMobile && ratio === '9:16') {
      // –ù–∞ –ü–ö –≤ 9:16 ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–º–∫—É-–≥–∏–¥
      aspectGuide.style.display = 'block';
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è 9:16 –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 16:9 —ç–∫—Ä–∞–Ω–∞
      const containerRatio = window.innerWidth / window.innerHeight;
      const targetRatio = 9 / 16;
      if (containerRatio > targetRatio) {
        // –®–∏—Ä–æ–∫–∏–π —ç–∫—Ä–∞–Ω ‚Üí —á—ë—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã –ø–æ –±–æ–∫–∞–º
        const targetWidth = window.innerHeight * targetRatio;
        const marginLeft = (window.innerWidth - targetWidth) / 2;
        aspectGuide.style.marginLeft = marginLeft + 'px';
        aspectGuide.style.width = targetWidth + 'px';
        aspectGuide.style.height = '100%';
      } else {
        // –£–∑–∫–∏–π —ç–∫—Ä–∞–Ω ‚Üí —á—ë—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É
        const targetHeight = window.innerWidth / targetRatio;
        const marginTop = (window.innerHeight - targetHeight) / 2;
        aspectGuide.style.marginTop = marginTop + 'px';
        aspectGuide.style.height = targetHeight + 'px';
        aspectGuide.style.width = '100%';
      }
    }
  }

  aspectRatioSelect.addEventListener('change', () => {
    if (!isMobile) {
      startCamera(aspectRatioSelect.value);
    }
  });

  // === –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑) ===
  function startScrolling() {
    if (scrollInterval) clearInterval(scrollInterval);
    const speed = parseFloat(speedControl.value);
    const container = document.getElementById('overlay-text-container');
    const posPercent = parseFloat(textPositionControl.value); // 0‚Äì100
    // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç –≤–µ—Ä—Ö–∞: —á–µ–º –±–æ–ª—å—à–µ posPercent, —Ç–µ–º –Ω–∏–∂–µ –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
    let topOffset = -textContent.scrollHeight + (container.clientHeight * (posPercent / 100));

    scrollInterval = setInterval(() => {
      topOffset -= speed;
      textContent.style.transform = `translateY(${topOffset}px)`;
      // –°–±—Ä–æ—Å, –∫–æ–≥–¥–∞ —Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—à—ë–ª –≤–≤–µ—Ä—Ö
      if (topOffset < -textContent.scrollHeight * 2) {
        topOffset = -textContent.scrollHeight + (container.clientHeight * (posPercent / 100));
      }
    }, 50);
  }

  [speedControl, fontSizeControl, textPositionControl].forEach(el =>
    el.addEventListener('input', () => {
      if (el === fontSizeControl) textContent.style.fontSize = el.value + 'px';
      startScrolling();
    })
  );

  // === –ó–∞–ø–∏—Å—å ===
  recordBtn.addEventListener('click', () => {
    if (!stream) return;

    // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MP4
    const mimeTypeMP4 = 'video/mp4;codecs=h264';
    const mimeTypeWebM = 'video/webm;codecs=vp9';
    let mimeType = mimeTypeMP4;

    if (!MediaRecorder.isTypeSupported(mimeTypeMP4)) {
      if (MediaRecorder.isTypeSupported(mimeTypeWebM)) {
        mimeType = mimeTypeWebM;
        console.warn('MP4 –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WebM');
      } else {
        mimeType = 'video/webm';
      }
    }

    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: mimeType });
      const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `teleprompter-recording.${ext}`;
      a.click();
      URL.revokeObjectURL(url);
      isRecording = false;
      recordBtn.classList.remove('recording');
      recordBtn.textContent = '‚è∫Ô∏è –ó–∞–ø–∏—Å–∞—Ç—å';
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    mediaRecorder.start();
    isRecording = true;
    recordBtn.classList.add('recording');
    recordBtn.textContent = 'üî¥ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...';
    recordBtn.disabled = true;
    stopBtn.disabled = false;
  });

  stopBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
  });

  // === –û—á–∏—Å—Ç–∫–∞ ===
  window.addEventListener('beforeunload', () => {
    stopCamera();
    if (isMobile) {
      window.removeEventListener('orientationchange', detectOrientationAndStart);
    }
  });
</script>
</body>
</html>
