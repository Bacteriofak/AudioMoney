<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–¢–µ–ª–µ—Å—É—Ñ–ª–µ—Ä Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
      color: white;
      height: 100dvh;
      overflow: hidden;
      position: relative;
    }

    .screen { display: none; height: 100%; }
    .screen.active { display: flex; flex-direction: column; }

    /* Setup Screen */
    #setup-screen {
      padding: 20px;
      gap: 20px;
    }
    textarea {
      width: 100%;
      height: 40dvh;
      padding: 12px;
      font-size: 18px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #111;
      color: white;
      resize: none;
    }
    .saved-texts {
      max-height: 30dvh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .saved-texts button {
      background: #333;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 6px;
      text-align: left;
      cursor: pointer;
    }
    .controls-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    /* Recording Screen */
    #recording-screen { position: relative; }
    #camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
      transform-origin: center;
      /* transform –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è JS */
    }

    /* –†–∞–º–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ */
    .aspect-guide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      box-sizing: border-box;
      border: 2px dashed rgba(255,255,255,0.4);
      display: none;
    }

    #overlay-text-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 20px;
    }
    #text-content {
      color: white;
      background: rgba(0, 0, 0, 0.6);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      line-height: 1.6;
      transform: translateY(0);
    }

    #recording-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.7);
      padding: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      z-index: 10;
    }
    .slider-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    input[type="range"] {
      width: 100px;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ */
    .recording {
      background: #e53935 !important;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.8; }
      100% { opacity: 1; }
    }

    /* –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã */
    #camera-settings {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      padding: 12px;
      border-radius: 10px;
      max-width: 300px;
      display: none;
      z-index: 20;
    }
    #camera-settings.active {
      display: block;
    }
    #camera-settings h3 {
      margin-bottom: 10px;
      font-size: 16px;
    }
    #camera-settings .setting-item {
      margin: 6px 0;
    }
    #camera-settings label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

<!-- Setup Screen -->
<div id="setup-screen" class="screen active">
  <h2>–¢–µ–∫—Å—Ç –¥–ª—è —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä–∞</h2>
  <textarea id="input-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å..."></textarea>
  <div class="saved-texts" id="saved-list"></div>
  <div class="controls-row">
    <button id="load-sample">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
    <button id="go-to-recording">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>
</div>

<!-- Recording Screen -->
<div id="recording-screen" class="screen">
  <video id="camera" autoplay playsinline muted></video>
  <div id="guide-9-16" class="aspect-guide"></div>
  <div id="guide-1-1" class="aspect-guide"></div>
  <div id="overlay-text-container">
    <div id="text-content"></div>
  </div>

  <div id="camera-settings">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</h3>
    <div id="camera-settings-content"></div>
  </div>

  <div id="recording-controls">
    <button id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
    <button id="recordBtn">‚è∫Ô∏è –ó–∞–ø–∏—Å–∞—Ç—å</button>
    <button id="stopBtn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button id="cameraSettingsBtn" style="display: none;">üé• –ö–∞–º–µ—Ä–∞</button>

    <div class="slider-group">
      <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
      <input type="range" id="speed" min="0.5" max="5" step="0.5" value="1">
    </div>
    <div class="slider-group">
      <label>–†–∞–∑–º–µ—Ä:</label>
      <input type="range" id="fontSize" min="16" max="64" value="32">
    </div>
    <div class="slider-group">
      <label>–ü–æ–∑–∏—Ü–∏—è:</label>
      <input type="range" id="textPosition" min="0" max="100" value="0">
    </div>
    <div class="slider-group">
      <label>–®–∏—Ä–∏–Ω–∞:</label>
      <input type="range" id="textWidth" min="20" max="100" value="80">
    </div>
    <div class="slider-group">
      <label>–†–µ–∂–∏–º:</label>
      <select id="aspectRatio">
        <option value="16:9" selected>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (YouTube)</option>
        <option value="9:16">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (Shorts/Reels)</option>
        <option value="1:1">–ö–≤–∞–¥—Ä–∞—Ç (Instagram)</option>
      </select>
    </div>
    <div class="slider-group" id="resolution-control" style="display: none;">
      <label>–ö–∞—á–µ—Å—Ç–≤–æ:</label>
      <select id="resolution">
        <option value="640,360">360p (640√ó360)</option>
        <option value="854,480">480p (854√ó480)</option>
        <option value="1280,720">720p (1280√ó720)</option>
        <option value="1920,1080" selected>1080p (1920√ó1080)</option>
        <option value="2560,1440">1440p (2560√ó1440)</option>
        <option value="3840,2160">4K (3840√ó2160)</option>
      </select>
    </div>
  </div>
</div>

<script>
  const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const savedTexts = JSON.parse(localStorage.getItem('teleprompterTexts') || '[]');
  let currentText = '';
  let stream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let scrollInterval = null;
  let isRecording = false;
  let videoTrack = null;
  let currentResolution = isMobile ? [1280, 720] : [1920, 1080];
  let currentScale = 1.0; // ‚Üê –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±

  // DOM
  const setupScreen = document.getElementById('setup-screen');
  const recordingScreen = document.getElementById('recording-screen');
  const inputText = document.getElementById('input-text');
  const savedList = document.getElementById('saved-list');
  const camera = document.getElementById('camera');
  const textContent = document.getElementById('text-content');
  const backBtn = document.getElementById('backBtn');
  const recordBtn = document.getElementById('recordBtn');
  const stopBtn = document.getElementById('stopBtn');
  const speedControl = document.getElementById('speed');
  const fontSizeControl = document.getElementById('fontSize');
  const textPositionControl = document.getElementById('textPosition');
  const textWidthControl = document.getElementById('textWidth');
  const aspectRatioSelect = document.getElementById('aspectRatio');
  const guide916 = document.getElementById('guide-9-16');
  const guide11 = document.getElementById('guide-1-1');
  const loadSampleBtn = document.getElementById('load-sample');
  const goToRecordingBtn = document.getElementById('go-to-recording');
  const cameraSettingsBtn = document.getElementById('cameraSettingsBtn');
  const cameraSettings = document.getElementById('camera-settings');
  const cameraSettingsContent = document.getElementById('camera-settings-content');
  const resolutionControl = document.getElementById('resolution-control');
  const resolutionSelect = document.getElementById('resolution');

  if (!isMobile) {
    cameraSettingsBtn.style.display = 'inline-block';
    resolutionControl.style.display = 'flex';
  }

  function renderSavedTexts() {
    savedList.innerHTML = '';
    savedTexts.forEach(text => {
      const btn = document.createElement('button');
      btn.textContent = text.substring(0, 50) + (text.length > 50 ? '...' : '');
      btn.onclick = () => inputText.value = text;
      savedList.appendChild(btn);
    });
  }
  renderSavedTexts();

  loadSampleBtn.addEventListener('click', () => {
    inputText.value = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç–µ–ª–µ—Å—É—Ñ–ª–µ—Ä Pro!\n–¢–µ–∫—Å—Ç —Ç–µ–ø–µ—Ä—å —Å—Ç–∞—Ç–∏—á–µ–Ω –¥–æ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏.\n–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–ó–∞–ø–∏—Å—å" –æ–Ω –Ω–∞—á–Ω—ë—Ç –ø–ª–∞–≤–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è –≤–≤–µ—Ä—Ö.`;
  });

  goToRecordingBtn.addEventListener('click', () => {
    currentText = inputText.value.trim();
    if (!currentText) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç.'); return; }
    if (!savedTexts.includes(currentText)) {
      savedTexts.push(currentText);
      localStorage.setItem('teleprompterTexts', JSON.stringify(savedTexts));
      renderSavedTexts();
    }
    textContent.textContent = currentText;
    applyTextStyles();
    setupScreen.classList.remove('active');
    recordingScreen.classList.add('active');
    startCamera();
    updateGuides();
  });

  backBtn.addEventListener('click', () => {
    recordingScreen.classList.remove('active');
    setupScreen.classList.add('active');
    stopCamera();
  });

  async function startCamera() {
    stopCamera();
    const [width, height] = currentResolution;
    const constraints = {
      video: { facingMode: 'user', width: { ideal: width }, height: { ideal: height } },
      audio: true
    };

    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      camera.srcObject = stream;
      videoTrack = stream.getVideoTracks()[0];
      
      if (!isMobile && videoTrack && typeof videoTrack.getCapabilities === 'function') {
        loadCameraSettings();
      }
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–∞—Å—à—Ç–∞–±
      camera.style.transform = `scale(${currentScale})`;
    } catch (err) {
      let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
      if (err.name === 'NotFoundError') msg = '–ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
      if (err.name === 'NotAllowedError') msg = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
      alert(msg + '\n\n–û—à–∏–±–∫–∞: ' + err.message);
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      videoTrack = null;
    }
    if (scrollInterval) {
      clearInterval(scrollInterval);
      scrollInterval = null;
    }
    cameraSettings.classList.remove('active');
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ + –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± ===
  function loadCameraSettings() {
    try {
      const capabilities = videoTrack ? videoTrack.getCapabilities() : {};
      cameraSettingsContent.innerHTML = '';

      // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
      const supported = ['zoom', 'focusDistance', 'exposureCompensation', 'brightness', 'contrast', 'saturation', 'whiteBalanceMode'];
      let hasNativeControls = false;

      supported.forEach(prop => {
        if (capabilities[prop]) {
          hasNativeControls = true;
          const range = capabilities[prop];
          const settings = videoTrack.getSettings();
          const currentValue = settings[prop] || (prop === 'zoom' ? 1 : 0);

          const div = document.createElement('div');
          div.className = 'setting-item';
          div.innerHTML = `
            <label>${prop} (${range.min} ‚Äì ${range.max})</label>
            <input type="range" id="cam-${prop}" min="${range.min}" max="${range.max}" step="${range.step || 1}" value="${currentValue}">
          `;
          cameraSettingsContent.appendChild(div);

          div.querySelector('input').addEventListener('input', async (e) => {
            try {
              const val = parseFloat(e.target.value);
              await videoTrack.applyConstraints({ advanced: [{ [prop]: val }] });
            } catch (err) {
              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å', prop, err);
            }
          });
        }
      });

      // === –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± ===
      const scaleDiv = document.createElement('div');
      scaleDiv.className = 'setting-item';
      scaleDiv.innerHTML = `
        <label>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± (0.6‚Äì1.5)</label>
        <input type="range" id="virtual-scale" min="0.6" max="1.5" step="0.05" value="${currentScale}">
      `;
      cameraSettingsContent.appendChild(scaleDiv);

      scaleDiv.querySelector('input').addEventListener('input', (e) => {
        currentScale = parseFloat(e.target.value);
        camera.style.transform = `scale(${currentScale})`;
      });

      cameraSettingsBtn.style.display = 'inline-block';

    } catch (err) {
      console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã', err);
      // –ù–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏–º!
      cameraSettingsContent.innerHTML = `
        <div class="setting-item">
          <label>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± (0.6‚Äì1.5)</label>
          <input type="range" id="virtual-scale" min="0.6" max="1.5" step="0.05" value="${currentScale}">
        </div>
      `;
      document.getElementById('virtual-scale').addEventListener('input', (e) => {
        currentScale = parseFloat(e.target.value);
        camera.style.transform = `scale(${currentScale})`;
      });
      cameraSettingsBtn.style.display = 'inline-block';
    }
  }

  cameraSettingsBtn.addEventListener('click', () => {
    cameraSettings.classList.toggle('active');
  });

  resolutionSelect.addEventListener('change', () => {
    const [w, h] = resolutionSelect.value.split(',').map(Number);
    currentResolution = [w, h];
    startCamera();
  });

  function updateGuides() {
    guide916.style.display = 'none';
    guide11.style.display = 'none';
    const ratio = aspectRatioSelect.value;
    if (ratio === '9:16') {
      guide916.style.display = 'block';
      const targetW = window.innerHeight * (9 / 16);
      const ml = (window.innerWidth - targetW) / 2;
      guide916.style.marginLeft = ml + 'px';
      guide916.style.width = targetW + 'px';
      guide916.style.height = '100%';
    } else if (ratio === '1:1') {
      guide11.style.display = 'block';
      const size = Math.min(window.innerWidth, window.innerHeight);
      const ml = (window.innerWidth - size) / 2;
      const mt = (window.innerHeight - size) / 2;
      guide11.style.marginLeft = ml + 'px';
      guide11.style.marginTop = mt + 'px';
      guide11.style.width = size + 'px';
      guide11.style.height = size + 'px';
    }
  }

  aspectRatioSelect.addEventListener('change', updateGuides);
  window.addEventListener('resize', updateGuides);

  function applyTextStyles() {
    textContent.style.fontSize = fontSizeControl.value + 'px';
    textContent.style.maxWidth = textWidthControl.value + '%';
  }

  fontSizeControl.addEventListener('input', applyTextStyles);
  textWidthControl.addEventListener('input', applyTextStyles);

  function startScrolling() {
    if (scrollInterval) clearInterval(scrollInterval);
    const speed = parseFloat(speedControl.value);
    const container = document.getElementById('overlay-text-container');
    const posPercent = parseFloat(textPositionControl.value);
    let topOffset = -textContent.scrollHeight + (container.clientHeight * (posPercent / 100));

    scrollInterval = setInterval(() => {
      topOffset -= speed;
      textContent.style.transform = `translateY(${topOffset}px)`;
      if (topOffset < -textContent.scrollHeight * 2) {
        topOffset = -textContent.scrollHeight + (container.clientHeight * (posPercent / 100));
      }
    }, 50);
  }

  textPositionControl.addEventListener('input', () => {
    if (!isRecording) {
      const container = document.getElementById('overlay-text-container');
      const posPercent = parseFloat(textPositionControl.value);
      const topOffset = -textContent.scrollHeight + (container.clientHeight * (posPercent / 100));
      textContent.style.transform = `translateY(${topOffset}px)`;
    }
  });

  recordBtn.addEventListener('click', () => {
    if (!stream) {
      alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä—ã.');
      return;
    }

    const hasAudio = stream.getAudioTracks().length > 0;
    if (!hasAudio) {
      if (!confirm('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ?')) return;
    }

    const mimeType = MediaRecorder.isTypeSupported('video/mp4;codecs=h264')
      ? 'video/mp4;codecs=h264'
      : MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
        ? 'video/webm;codecs=vp9'
        : 'video/webm';

    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: mimeType });
      const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `teleprompter-recording.${ext}`;
      a.click();
      URL.revokeObjectURL(url);
      isRecording = false;
      recordBtn.classList.remove('recording');
      recordBtn.textContent = '‚è∫Ô∏è –ó–∞–ø–∏—Å–∞—Ç—å';
      recordBtn.disabled = false;
      stopBtn.disabled = true;
      if (scrollInterval) {
        clearInterval(scrollInterval);
        scrollInterval = null;
      }
      textPositionControl.dispatchEvent(new Event('input'));
    };

    mediaRecorder.start();
    isRecording = true;
    recordBtn.classList.add('recording');
    recordBtn.textContent = 'üî¥ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...';
    recordBtn.disabled = true;
    stopBtn.disabled = false;
    startScrolling();
  });

  stopBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    }
  });

  window.addEventListener('beforeunload', stopCamera);
</script>
</body>
</html>
